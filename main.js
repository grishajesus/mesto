(()=>{"use strict";const e=new class{constructor(e){const{baseUrl:t,headers:s}=e;this.baseUrl=t,this.headers=s,this.defaultHandleResponse=this._defaultHandleResponse.bind(this)}async getCurrentUser(){const e=this.baseUrl+"/users/me";try{return await fetch(e,{headers:this.headers}).then(this.defaultHandleResponse)}catch(e){console.error(e)}}async getPlaces(){const e=this.baseUrl+"/cards";try{return await fetch(e,{headers:this.headers}).then(this.defaultHandleResponse)}catch(e){console.error(e)}}async updateUser(e){const t=this.baseUrl+"/users/me";try{return await fetch(t,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(e)}).then(this.defaultHandleResponse)}catch(e){console.log(e)}}async updateUserAvatar(e){const t=this.baseUrl+"/users/me/avatar",s={avatar:e};try{return await fetch(t,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(s)}).then(this.defaultHandleResponse)}catch(e){console.log(e)}}async createCard(e){const t=this.baseUrl+"/cards";try{return await fetch(t,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(e)}).then(this.defaultHandleResponse)}catch(e){console.error(e)}}async deleteCard(e){const t=this.baseUrl+"/cards/"+e;try{return await fetch(t,{method:"DELETE",headers:this.headers}).then(this.defaultHandleResponse)}catch(e){console.error(e)}}async createLike(e){const t=this.baseUrl+`/cards/${e}/likes`;try{return await fetch(t,{method:"PUT",headers:this.headers}).then(this.defaultHandleResponse)}catch(e){console.error(e)}}async deleteLike(e){const t=this.baseUrl+`/cards/${e}/likes`;try{return await fetch(t,{method:"DELETE",headers:this.headers}).then(this.defaultHandleResponse)}catch(e){console.error(e)}}_defaultHandleResponse(e){return e.ok?e.json():Promise.reject(e.status)}}({baseUrl:"https://nomoreparties.co/v1/cohort-28",headers:{authorization:"d70652f2-87da-4c2e-8e5b-697807750bdf"}});class t{constructor(e){this.popup=document.querySelector(e)}open(){this.popup&&(this.popup.style.display="flex",this.popup.classList.add("popup_opened"),this.popup.addEventListener("click",this._handleClickOverlayClose.bind(this)),document.body.addEventListener("keydown",this._handleEscClose.bind(this)))}close(){this.popup&&(this.popup.classList.remove("popup_opened"),this.popup.removeEventListener("click",this._handleClickOverlayClose.bind(this)),document.body.removeEventListener("keydown",this._handleEscClose.bind(this)))}setEventListeners(){this.popup.querySelector(".popup__close-button").addEventListener("click",(()=>this.close()))}_handleClickOverlayClose(e){e.target.classList.contains("popup")&&this.close(this.popup)}_handleEscClose(e){"Escape"===e.code&&null!==this.popup&&this.close()}}class s extends t{constructor(e,t){super(e),this.form=this.popup.querySelector("form"),this.submitButton=this.form.querySelector("button[type=submit]"),this.validator=null,this.onSubmitted=null,this.onSubmitForm=t}close(){super.close(),this.popup.querySelector("form").reset(),this.validator&&this.validator.disableValidation()}enableLoading(){const e=this.submitButton.textContent;this.submitButton.setAttribute("data-origin-text",e),this.submitButton.textContent="Сохранение..."}disableLoading(){const e=this.submitButton.getAttribute("data-origin-text");this.submitButton.removeAttribute("origin-text"),this.submitButton.textContent=e}setOnSubmitted(e){this.onSubmitted=e}setValidator(e){this.validator=e,this.validator.enableValidation()}setInputValues(e){Object.entries(e).forEach((([e,t])=>{const s=this._getInput(`input[name=${e}]`);s&&(s.value=t)}))}setEventListeners(){super.setEventListeners(),this.form.addEventListener("submit",this.onSubmitForm.bind(this))}_getInput(e){return this.form.querySelector(e)}_getInputValues(e){return Object.fromEntries(new FormData(e.target))}}const i=new class extends t{open(e,t){this.popup.querySelector(".popup-image__image").src=e,this.popup.querySelector(".popup-image__title").textContent=t,super.open()}}(".popup_type_image");i.setEventListeners();const r=new s(".popup_type_profile",(async function(e){e.preventDefault();const t=this._getInputValues(e);this.enableLoading(),await this.onSubmitted(t),this.disableLoading(),this.close()}));r.setEventListeners();const n=new s(".popup_profile-avatar",(async function(e){e.preventDefault();const t=this._getInputValues(e);this.enableLoading(),await this.onSubmitted(t),this.disableLoading(),this.close()}));n.setEventListeners();const a=new s(".popup_type_card-add",(async function(e){e.preventDefault();const t=this._getInputValues(e);this.enableLoading(),await this.onSubmitted(t),this.disableLoading(),this.close()}));a.setEventListeners();const o=new class extends t{constructor(e,t){super(e),this.form=this.popup.querySelector("form"),this.submitButton=this.form.querySelector("button[type=submit]"),this.onSubmitted=null,this.onSubmitForm=t.bind(this)}enableLoading(){const e=this.submitButton.textContent;this.submitButton.setAttribute("data-origin-text",e),this.submitButton.textContent="Загрузка..."}disableLoading(){const e=this.submitButton.getAttribute("data-origin-text");this.submitButton.removeAttribute("origin-text"),this.submitButton.textContent=e}setOnSubmitted(e){this.onSubmitted=e}setEventListeners(){super.setEventListeners(),this.form.addEventListener("submit",this.onSubmitForm)}}(".popup_sure",(async function(e){e.preventDefault(),this.enableLoading(),await this.onSubmitted(),this.disableLoading(),this.close()}));o.setEventListeners();const l={inputSelector:".popup__input",submitButtonSelector:".popup__submit-button",inactiveButtonClass:"popup__submit-button_error",inputErrorClass:"popup__input_type_error",errorClass:"popup__input-error_visible"};class c{constructor(e,t){this.form=document.querySelector(e),this.selectors=t,this.onSetListener=this._setListener.bind(this)}_setEventListeners(){this.form.querySelectorAll(this.selectors.inputSelector).forEach((e=>{e.addEventListener("input",this.onSetListener)}))}_resetEventListeners(){this.form.querySelectorAll(this.selectors.inputSelector).forEach((e=>{e.removeEventListener("input",this.onSetListener)}))}_setListener(e){this._setInputListener(e.target),this._checkIsPossibleSubmit()}_setInputListener(e){const t=this.form.querySelector(`#${e.name}-error`),s=e.validity;let i="";e.value.length?s.tooShort||s.tooLong?i=`Неправильно заполнено поле! Введено ${e.value.length}, должно быть от ${e.getAttribute("minlength")} до ${e.getAttribute("maxlength")}`:s.typeMismatch&&(i="Это не ссылка"):i="Вы пропустили это поле",i?(e.classList.add(this.selectors.inputErrorClass),t.classList.add(this.selectors.errorClass)):(e.classList.remove(this.selectors.inputErrorClass),t.classList.remove(this.selectors.errorClass)),t.textContent=i}_checkIsPossibleSubmit(){const e=this.form.querySelector(this.selectors.submitButtonSelector);this.form.checkValidity()?(e.classList.remove(this.selectors.inactiveButtonClass),e.removeAttribute("disabled")):(e.classList.add(this.selectors.inactiveButtonClass),e.setAttribute("disabled","disabled"))}_resetErrors(){this.form.querySelectorAll(this.selectors.inputSelector).forEach((e=>{this.form.querySelector(`#${e.name}-error`).textContent=""}))}enableValidation(){this._checkIsPossibleSubmit(),this._setEventListeners()}disableValidation(){this._resetEventListeners(),this._resetErrors()}}const h=new c('form[name="profile-settings__form"]',l),d=new c('form[name="profile-edit-avatar__form"]',l),u=new c('form[name="place-add-card__form"]',l),p=new class{constructor(e,t){this.api=e,this.presenter=t,this._userProfile=null}async init(){this._userProfile=await this.api.getCurrentUser(),this.presenter.setUserProfile(this._userProfile),this.presenter.setCallbacks({onSaveSettings:this.api.updateUser.bind(e),onSaveAvatar:this.api.updateUserAvatar.bind(e)}),this.presenter.render()}getUserProfile(){return this._userProfile}getUserId(){return this.getUserProfile()._id}}(e,new class{constructor(e){const{avatarSelector:t,nameSelector:s,descriptionSelector:i,editButtonSelector:r,editAvatarButtonSelector:n}=e;this.avatar=document.querySelector(t),this.name=document.querySelector(s),this.description=document.querySelector(i),this.editButton=document.querySelector(r),this.editAvatarButton=document.querySelector(n),this.callbacks={}}setCallbacks(e){this.callbacks=e}setUserProfile(e){this.userProfile=e}getUserProtfile(){return this.userProfile}setUserAvatar(e){const{avatar:t,name:s}=e;this.avatar.src=t,this.avatar.alt=s}setUserInfo(e){const{name:t,about:s}=e;this.name.textContent=t,this.description.textContent=s}render(){this._setEventListener(),this.setUserAvatar(this.userProfile),this.setUserInfo(this.userProfile)}_handleSettingsSubmit=async e=>{const{onSaveSettings:t}=this.callbacks;await t(e),this.setUserInfo(e)};_handleClickOpenEditPopup=()=>{const{name:e,about:t}=this.userProfile;r.setOnSubmitted(this._handleSettingsSubmit),r.setInputValues({name:e,about:t}),r.setValidator(h),r.open()};_handleEditAvatarSubmit=async e=>{const{avatar:t}=e,{name:s}=this.userProfile,{onSaveAvatar:i}=this.callbacks;await i(t),this.setUserAvatar({avatar:t,name:s})};_handleClickOpenAvatarPopup=()=>{const{avatar:e}=this.userProfile;n.setOnSubmitted(this._handleEditAvatarSubmit),n.setInputValues({avatar:e}),n.setValidator(d),n.open()};_setEventListener(){this.editAvatarButton.addEventListener("click",this._handleClickOpenAvatarPopup),this.editButton.addEventListener("click",this._handleClickOpenEditPopup)}}({avatarSelector:".profile__pic img",nameSelector:".profile__name",descriptionSelector:".profile__job",editButtonSelector:".profile__edit-button",editAvatarButtonSelector:".profile__pic-edit"}));class m{constructor(e,t){this.items=e.items,this.renderer=e.renderer,this.container=document.querySelector(t)}setItems(e){this.items=e}addItem(e){this.container.prepend(e)}render(){if(0===this.items.length||!this.renderer)return null;this.items.forEach((e=>this.renderer(e)))}}class _{constructor({place:e,templateSelector:t,canDelete:s,likeSetted:i,callbacks:r}){this.place=e,this.templateSelector=document.querySelector(t),this.canDelete=s,this.likeSetted=i,this.element=null,this.likesCounterBox=null,this.callbacks=r}_shapeElementFromTemplate(){const e=this.templateSelector.content;this.element=e.querySelector(".place-card").cloneNode(!0),this.canDelete||this.element.querySelector(".place-card__delete").remove();const t=this.element.querySelector(".place-card__name"),s=this.element.querySelector(".place-card__image"),i=this.element.querySelector(".place-card__likes");return t.textContent=this.place.name,i.textContent=(this.place.likes??[]).length,s.src=this.place.link,s.alt=this.place.name,this.likeSetted&&this.element.querySelector(".place-card__like-icon").classList.add("place-card__like-icon_active"),this.likesCounterBox=this.element.querySelector(".place-card__likes"),this.element}_handleClickCard=()=>{const{onClickCard:e}=this.callbacks;e(this.place.link,this.place.name)};_handleDelete=()=>{const{onDeleteCard:e}=this.callbacks;e(this.place._id,(()=>this.element.remove()))};_handleToggleLike=async e=>{const{onSetLike:t}=this.callbacks,s=e.target.classList.contains("place-card__like-icon_active");e.target.classList.toggle("place-card__like-icon_active"),s?this._decreaseLike():this._increaseLike(),await t(this.place._id,s)};_increaseLike(){const e=parseInt(this.likesCounterBox.textContent,10);this.likesCounterBox.textContent=e+1}_decreaseLike(){const e=parseInt(this.likesCounterBox.textContent,10);this.likesCounterBox.textContent=e-1}_setListeners(){const e=this.element.querySelector(".place-card__delete");e&&e.addEventListener("click",this._handleDelete),this.element.querySelector(".place-card__like-icon").addEventListener("click",this._handleToggleLike),this.element.querySelector(".place-card__image").addEventListener("click",this._handleClickCard)}createDOMNode(){return this._shapeElementFromTemplate(),this._setListeners(),this.element}}const b=new class{constructor(e,t){this.api=e,this.presenter=t,this.userService=null}async init(){const t=await this.api.getPlaces();this.presenter.setPlaces(t),this.presenter.setCallbacks({onCreateCard:this.api.createCard.bind(e),onDeleteCard:this.api.deleteCard.bind(e),onCreateLike:this.api.createLike.bind(e),onDeleteLike:this.api.deleteLike.bind(e),onCanDeleteCard:this._canDeleteCard,onLikeSettedByUser:this._likeSettedByUser}),this.presenter.render()}setUserService(e){this.userService=e}_canDeleteCard=e=>this.userService.getUserId()===e;_likeSettedByUser=e=>{const t=this.userService.getUserId();return!!e.find((e=>e._id===t))}}(e,new class{constructor({listSelector:e,cardTemplateSelector:t,createButtonSelector:s}){this.list=e,this.cardTemplate=t,this.createButton=document.querySelector(s),this._handleClickCard=i.open.bind(i),this.places=[],this.placesSection=null,this.callbacks={}}setPlaces(e){this.places=e}setCallbacks(e){this.callbacks=e}render(){const{onCanDeleteCard:e,onLikeSettedByUser:t}=this.callbacks;this._setEventListeners(),this.placesSection=new m({items:[...this.places].reverse(),renderer:s=>{const i=new _({place:s,templateSelector:this.cardTemplate,canDelete:e(s.owner._id),likeSetted:t(s.likes),callbacks:{onClickCard:this._handleClickCard,onDeleteCard:this._handleDeleteCard,onSetLike:this._handleSetLike}}).createDOMNode();this.placesSection.addItem(i)}},this.list),this.placesSection.render()}_handleCreateSubmit=async e=>{const{onCreateCard:t}=this.callbacks,s=await t({name:e.name,link:e.link}),i=new _({place:s,templateSelector:this.cardTemplate,canDelete:!0,canSetLike:!0,callbacks:{onClickCard:this._handleClickCard,onDeleteCard:this._handleDeleteCard,onSetLike:this._handleSetLike}}).createDOMNode();this.placesSection.addItem(i)};_handleSetLike=async(e,t)=>{const{onCreateLike:s,onDeleteLike:i}=this.callbacks;t?await i(e):await s(e)};_handleDeleteCard=(e,t)=>{const{onDeleteCard:s}=this.callbacks;o.setOnSubmitted((async()=>{await s(e),t()})),o.open()};_handleClickOpenCreatePopup=()=>{a.setOnSubmitted(this._handleCreateSubmit),a.setValidator(u),a.open()};_setEventListeners(){this.createButton.addEventListener("click",this._handleClickOpenCreatePopup)}}({listSelector:"#places-list",cardTemplateSelector:"#place-card-template",createButtonSelector:".profile__add-button"}));(async()=>{await p.init(),b.setUserService(p),await b.init()})()})();